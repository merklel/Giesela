<html>
	<head>
		<link href="designV2.css" type="text/css" rel="stylesheet">
		<title>Gi&szligela</title>
		<link rel="icon" href="favicon.png" type="image/png" />

    <script src="jquery-3.6.0.min.js"></script>
	</head>
	<body>	
		<div class="container">
				<h1 id="ueberschrift"> Gi&szligela gie&szligt den Balkon</h1><br/><br/>
				
				<button class="button1" name="jetztGiesen" value=1 onclick="buttonGiessen('1')">jetzt Gie&szligen!</button>
				<br/>
				<br/>
				
				<div class="status">
					<h2>Status</h2>
          <p><span hidden="true" id="online" style="color:#1faa36; font-weight: bold;">online</span><span  hidden="false" id="offline" style="color:#ff5100; font-weight: bold;">offline</span><br/></p>
					<p><b>letzter Gie&szligzeitpunkt:</b> <br/>
					<span id="lastWater"></span>
					<p><b>Wasserstand:</b> <span id="level"></span> Wasserstand in l</p>
				</div>
				
				<div class="einstellungen">
					<h2>Einstellungen</h2>
					<p>
          <b>Automatisches Gie&szligen zu folgenden Zeitpunkten:</b>
					<form id="settingsForm">
					<p>
					Gie&szlig-Zeitpunkt 1:<input type="checkbox" name="b_slot1" id="b_slot1"><input type="time" name="t_slot1" value="10:00" id="t_slot1"> Dauer: <input type="number" min=1 max=20 name="duration_slot1" id="duration_slot1" value=5> Minuten<br/>
					Gie&szlig-Zeitpunkt 2:<input type="checkbox" name="b_slot2" id="b_slot2"><input type="time" name="t_slot2" value="10:00" id="t_slot2"> Dauer: <input type="number" min=1 max=20 name="duration_slot2" id="duration_slot2" value=5> Minuten<br/>
					Gie&szlig-Zeitpunkt 3:<input type="checkbox" name="b_slot3" id="b_slot3"><input type="time" name="t_slot3" value="10:00" id="t_slot3"> Dauer: <input type="number" min=1 max=20 name="duration_slot3" id="duration_slot3" value=5> Minuten<br/>
					<p>
					Wasserstand zur&uuml;cksetzen: <input type="checkbox" name="waterReset" id="waterReset"><br/>
					<input type="submit" value="speichern">
          </form>
					<br/>
					<br/>
				</div>


				<div class="einstellungen">
					<h2>Log-File</h2>
					<div class="log">
            <span id="log" style="white-space: pre-line">
            HERE WILL THE LOGFILE BE!
          </span>
					</div>
				</div>


		</div>
	
	</body>
  <script>

    api_url = "192.168.1.45"
    api_port = "8000"

    function parseValue(key, value){
      if (key == "duration_slot1" || key == "duration_slot2" || key == "duration_slot3"){
        return Number(value)
      }
      if (value == "on"){
        return true
      }
      if (value == "off"){
        return false
      }
      return value
    }

    function save_settings(e){
      e.preventDefault();

      body={
          "b_slot1": false,
          "b_slot2": false,
          "b_slot3": false,
          "t_slot1": "08:00",
          "t_slot2": "12:00",
          "t_slot3": "18:00",
          "duration_slot1": 5,
          "duration_slot2": 5,
          "duration_slot3": 5,
          "waterReset": false,
      }

      console.log("Save settings")
      var dataArray = $('#settingsForm').serializeArray();
      for(var i=0;i<dataArray.length;i++){
        body[dataArray[i].name] = parseValue(dataArray[i].name, dataArray[i].value);
        }
        console.log("To send: ", body)

        $.ajax({
          type: "POST",
          async: false,
          url: "http://" + api_url + ":" + api_port + "/saveSettings",
          data: JSON.stringify(body),
          headers: {
              "Content-Type": "application/json",
          },
          success: function(result) {
              console.log("settings got saved", result)
          }
      })
    }

    function getSettings(){
      $.ajax({
          type: "GET",
          async: false,
          url: "http://" + api_url + ":" + api_port + "/getSettings",
          headers: {
          },
          success: function(result) {
              $("#b_slot1").prop("checked", result.b_slot1)
              $("#b_slot2").prop("checked", result.b_slot2)
              $("#b_slot3").prop("checked", result.b_slot3)
              $("#t_slot1").val(result.t_slot1)
              $("#t_slot2").val(result.t_slot2)
              $("#t_slot3").val(result.t_slot3)
              $("#duration_slot1").val(result.duration_slot1)
              $("#duration_slot2").val(result.duration_slot2)
              $("#duration_slot3").val(result.duration_slot3)
              $("#level").html(result.level)

              var a = new Date(result.lastWater * 1000);
              $("#lastWater").html(a.getDate() + "." + a.getMonth() + " " + a.getHours() + ":" + a.getMinutes())


              console.log(result)
          }
      })
    }

    function getHealth(){
      $.ajax({
          type: "GET",
          async: false,
          url: "http://" + api_url + ":" + api_port + "/health",
          timeout: 1,
          headers: {
          },
          success: function(result) {
              console.log("Giesela online!")
              $("#online").prop("hidden", false);
              $("#offline").prop("hidden", true);
              
          },
          error: function(request, status, error) {
            console.log("Giesela offline!")
            $("#online").prop("hidden", true);
            $("#offline").prop("hidden", false);
          }
      })
    }

    var settingsForm = document.getElementById("settingsForm");
    console.log(settingsForm)
    settingsForm.addEventListener("submit", save_settings);


    function buttonGiessen(duration) {
      $.ajax({
          type: "POST",
          async: false,
          url: "http://" + api_url + ":" + api_port + "/giessen",
          data: JSON.stringify({ "durationSeconds": Number(duration)}),
          headers: {
              "Content-Type": "application/json",
          },
          success: function(result) {
              console.log("giessen result: ", result)
          }
      })
  }

  function getLog() {
      $.ajax({
          type: "GET",
          async: false,
          url: "http://" + api_url + ":" + api_port + "/getLog",
          headers: {
          },
          success: function(result) {
              $("#log").html(result.logContent)
              console.log(result)
          }
      })
  }

  getLog();
  getSettings();
  getHealth();

  setInterval(getHealth,5000)


  </script>
</html>